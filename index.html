<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Мой вишлист</title>
  <meta name="description" content="Личный вишлист — желания, ссылки на магазины и статус покупки." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1>Мой вишлист</h1>
      <p class="subtitle">Здесь я собираю вещи, которые хочу. Можно открыть карточку, посмотреть заметки и перейти в магазин.</p>
      <div class="controls">
        <input id="search" type="search" placeholder="Поиск по названию, тегам или заметкам…" aria-label="Поиск">
        <select id="statusFilter" aria-label="Фильтр по статусу">
          <option value="all" selected>Все статусы</option>
          <option value="wanted">Хочу</option>
          <option value="ordered">Заказано</option>
          <option value="received">Получено</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="grid" class="grid" aria-live="polite"></div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <small>Обновлено: <span id="updatedAt"></span> · Сделано на GitHub Pages</small>
    </div>
  </footer>

  <template id="card-template">
    <article class="card">
      <a class="image-wrap" target="_blank" rel="noopener" href="#">
        <img alt="" loading="lazy">
        <span class="badge"></span>
      </a>
      <div class="card-body">
        <h3 class="title"></h3>
        <p class="notes"></p>
        <div class="meta">
          <span class="price"></span>
          <div class="tags"></div>
        </div>
        <div class="actions">
          <a class="btn" target="_blank" rel="noopener">Открыть магазин</a>
        </div>
      </div>
    </article>
  </template>

  <script>
    const state = {
      items: [],
      query: "",
      status: "all",
    };

    const grid = document.getElementById('grid');
    const search = document.getElementById('search');
    const statusFilter = document.getElementById('statusFilter');
    const updatedAt = document.getElementById('updatedAt');
    const cardTpl = document.getElementById('card-template');

    function fmtPrice(p) {
      return p || "";
    }

    function badgeText(status) {
      switch (status) {
        case "wanted": return "Хочу";
        case "ordered": return "Заказано";
        case "received": return "Получено";
        default: return "";
      }
    }

    function badgeClass(status) {
      return `badge-${status}`;
    }

    function render() {
      const q = state.query.trim().toLowerCase();
      const st = state.status;
      const filtered = state.items.filter(it => {
        const inStatus = (st === "all" || it.status === st);
        const text = (it.title || "") + " " + (it.notes || "") + " " + (it.tags || []).join(" ");
        const inQuery = !q || text.toLowerCase().includes(q);
        return inStatus && inQuery;
      });

      grid.innerHTML = "";
      filtered.forEach(it => {
        const node = cardTpl.content.cloneNode(true);
        const card = node.querySelector('.card');
        const img = node.querySelector('img');
        const aImg = node.querySelector('.image-wrap');
        const badge = node.querySelector('.badge');
        const title = node.querySelector('.title');
        const notes = node.querySelector('.notes');
        const price = node.querySelector('.price');
        const tags = node.querySelector('.tags');
        const btn = node.querySelector('.btn');

        title.textContent = it.title || "Без названия";
        notes.textContent = it.notes || "";
        price.textContent = fmtPrice(it.price);
        btn.href = it.url || "#";
        btn.setAttribute('aria-label', `Открыть магазин: ${it.title || ''}`);

        aImg.href = it.url || "#";

        // Image & fallback
        if (it.image) {
          img.src = it.image;
          img.alt = it.title || "";
          img.onerror = () => {
            img.remove();
            aImg.classList.add('no-image');
            aImg.setAttribute('data-fallback', (it.title || "W")[0].toUpperCase());
          };
        } else {
          img.remove();
          aImg.classList.add('no-image');
          aImg.setAttribute('data-fallback', (it.title || "W")[0].toUpperCase());
        }

        // Badge
        if (it.status) {
          badge.textContent = badgeText(it.status);
          badge.classList.add('badge', badgeClass(it.status));
        } else {
          badge.remove();
        }

        // Tags
        if (Array.isArray(it.tags)) {
          it.tags.forEach(t => {
            const span = document.createElement('span');
            span.className = 'tag';
            span.textContent = t;
            tags.appendChild(span);
          });
        }

        grid.appendChild(node);
      });

      updatedAt.textContent = new Date().toLocaleDateString('ru-RU', { year:'numeric', month:'long', day:'numeric' });
    }

    fetch('wishlist.json', { cache: 'no-store' })
      .then(r => r.json())
      .then(items => { state.items = items; render(); })
      .catch(err => {
        grid.innerHTML = '<p class="error">Не удалось загрузить wishlist.json. Убедись, что файл лежит в корне репозитория.</p>';
        console.error(err);
      });

    search.addEventListener('input', (e) => { state.query = e.target.value; render(); });
    statusFilter.addEventListener('change', (e) => { state.status = e.target.value; render(); });
  </script>
</body>
</html>
